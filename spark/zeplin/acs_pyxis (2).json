{"paragraphs":[{"text":"%spark.pyspark\nimport os\nimport urllib.request\nimport zipfile\nimport json\n","user":"anonymous","dateUpdated":"2020-08-17T13:33:20+0000","config":{"tableHide":false,"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1597655514393_-458975244","id":"20200603-130026_1672067123","dateCreated":"2020-08-17T09:11:54+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:690","dateFinished":"2020-08-17T13:33:20+0000","dateStarted":"2020-08-17T13:33:20+0000"},{"text":"%spark.pyspark\r\n\r\nfrom pyspark.sql import SparkSession\r\nspark = SparkSession.builder.appName('acsdata').getOrCreate()\r\nes_hadoop = urllib.request.URLopener()\r\nes_hadoop.retrieve(\"http://download.elastic.co/hadoop/elasticsearch-hadoop-6.1.1.zip\", \"es-hadoop.zip\")\r\nwith zipfile.ZipFile(\"es-hadoop.zip\",\"r\") as zip_ref:\r\n    zip_ref.extractall()\r\n    \r\nos.environ['PYSPARK_SUBMIT_ARGS'] = '--jars elasticsearch-hadoop-6.1.1/dist/elasticsearch-spark-20_2.11-6.1.1.jar pyspark-shell'","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"tableHide":false,"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1597655514398_-1326501058","id":"20200603-140303_2021249394","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:691"},{"text":"%spark.pyspark\r\n\r\nfrom pyspark.sql import SparkSession\r\nspark = SparkSession.builder.appName('acsdata').getOrCreate()","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1597655514398_-25955647","id":"20200605-065932_541237539","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:692"},{"text":"%spark.pyspark\r\n\r\nes_write_conf_acs = {\r\n    \"es.nodes\" : \"https://vpc-elasticsearch-polarisapps-qc-kttkced2njswnhaa2n4mbou2cq.us-east-1.es.amazonaws.com\",\r\n    \"es.port\" : \"443\",\r\n    \"es.net.ssl\": \"true\",\r\n    \"es.nodes.wan.only\": \"true\",\r\n    \"es.resource\" : \"acsdata/data\",\r\n    \"es.input.json\" : \"yes\",\r\n\t\"es.mapping.id\": \"id\"\r\n}","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1597655514398_-2085004607","id":"20200605-074251_246399432","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:693"},{"text":"%spark.pyspark\r\ndf = spark.read.json('S3://271849239056-dev-datagov-stage-s3/datasource=acs/acs-pyxis/B25119')\r\ndf.printSchema()","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"root\n |-- estimateAnnotation: string (nullable = true)\n |-- estimateValue: long (nullable = true)\n |-- geoId: string (nullable = true)\n |-- marginAnnotation: string (nullable = true)\n |-- marginOfErrorValue: long (nullable = true)\n |-- variableCode: string (nullable = true)\n |-- vintage: long (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1597655514399_-1857995570","id":"20200605-075313_120424338","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:694"},{"text":"%spark.pyspark\ndef generate_Additional_Fields(geoId,vintage,variableCode):\n    zipCode=geoId.split('US')[1]\n    variableCodeType=variableCode.split('_')[1]\n    id ='{}-{}-{}'.format(zipCode,vintage,variableCode)\n    return {'id':id,'zipCode':zipCode,'variableCodeType':variableCodeType}","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1597655514399_-662420365","id":"20200605-080634_1833238006","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:695"},{"text":"%spark.pyspark\ngenerate_Additional_Fields('8600000US006012018B25064_001',1,'c_c')","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"{'id': '006012018B25064_001-1-c_c', 'zipCode': '006012018B25064_001', 'variableCodeType': 'c'}\n"}]},"apps":[],"jobName":"paragraph_1597655514399_-1183165715","id":"20200605-080702_2043374992","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:696"},{"text":"%spark.pyspark\ndef formatter(x):\n    additional_Fields=generate_Additional_Fields(x.geoId,x.vintage,x.variableCode)\n    id=additional_Fields['id']\n    return (id,json.dumps({\n                     'id':id,\n                      'zipCode':additional_Fields['zipCode'],\n                      'variableCodeType':additional_Fields['variableCodeType'],\n                     'estimateAnnotation':x.estimateAnnotation,\n                     'estimateValue':x.estimateValue,\n                     'geoId':x.geoId,\n                     'marginAnnotation':x.marginAnnotation,\n                     'marginOfErrorValue':x.marginOfErrorValue,\n                     'variableCode':x.variableCode,\n                     'vintage':x.vintage\n                    })\n           )","user":"anonymous","dateUpdated":"2020-08-17T13:33:25+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1597655514399_-518795617","id":"20200605-080715_1536189257","dateCreated":"2020-08-17T09:11:54+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:697","dateFinished":"2020-08-17T13:33:25+0000","dateStarted":"2020-08-17T13:33:25+0000"},{"text":"%spark.pyspark\nformattedata = df.rdd.map(lambda x:formatter(x))","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1597655514399_1274621706","id":"20200605-080727_328263989","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:698"},{"text":"%spark.pyspark\nformattedata.take(1)","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"[('00601-2018-B25119_001', '{\"id\": \"00601-2018-B25119_001\", \"zipCode\": \"00601\", \"variableCodeType\": \"001\", \"estimateAnnotation\": \"\", \"estimateValue\": 13092, \"geoId\": \"8600000US00601\", \"marginAnnotation\": \"\", \"marginOfErrorValue\": 1049, \"variableCode\": \"B25119_001\", \"vintage\": 2018}')]\n"}]},"apps":[],"jobName":"paragraph_1597655514400_835984618","id":"20200605-080735_187928323","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:699"},{"text":"%spark.pyspark\nformattedata.count()","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"794880\n"}]},"apps":[],"jobName":"paragraph_1597655514400_-407855744","id":"20200605-080744_1380217371","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:700"},{"text":"%spark.pyspark\nformattedata.saveAsNewAPIHadoopFile(\n\tpath='-',\n\toutputFormatClass=\"org.elasticsearch.hadoop.mr.EsOutputFormat\",\n\tkeyClass=\"org.apache.hadoop.io.NullWritable\",\n\tvalueClass=\"org.elasticsearch.hadoop.mr.LinkedMapWritable\",\n\tconf=es_write_conf_acs)\n","user":"anonymous","dateUpdated":"2020-08-17T09:11:54+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1597655514400_-1772223397","id":"20200605-080758_851267334","dateCreated":"2020-08-17T09:11:54+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:701"},{"user":"anonymous","dateUpdated":"2020-08-17T13:39:39+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1597655514400_1395410215","id":"20200605-080831_212956964","dateCreated":"2020-08-17T09:11:54+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:702","text":"%spark.pyspark\r\ndef create_calculated_value(variableCode , variableCodeType, zipCode, vintage, estimatedValue):\r\n    if(variableCode == \"B25119\"):\r\n        return estimatedValue\r\n    if(variableCode == \"B25064\"):\r\n        query = {\r\n            \"query\": {\r\n             \"bool\": {\r\n                 \"filter\": [\r\n                    {\r\n                        \"bool\": {\r\n                            \"must\": [\r\n                                {\r\n                                    \"match\": {\r\n                                        \"variableCode\": \"B25119\"\r\n                                    }\r\n                                },\r\n                                {\r\n                                    \"match\": {\r\n                                        \"variableCodeType\":\"002\"\r\n                                    }\r\n                                },\r\n                                {\r\n                                    \"match\": {\r\n                                         \"geoId\": zipCode\r\n                                    }\r\n                                },\r\n                                {\r\n                                    \"match\": {\r\n                                         \"vintage\": vintage\r\n                                    }\r\n                                }\r\n                            ]\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        }\r\n        }\r\n        es_read_conf = {\r\n            \"es.nodes\": \"https://vpc-elasticsearch-polarisapps-qc-kttkced2njswnhaa2n4mbou2cq.us-east-1.es.amazonaws.com\",\r\n            \"es.port\": \"443\",\r\n            \"es.resource\": \"pyxis-demographics/demographics\",\r\n            \"es.nodes.wan.only\": \"true\",\r\n            \"es.query\": json.dumps(query)\r\n        }\r\n        es_rdd = sc.newAPIHadoopRDD(\r\n            inputFormatClass=\"org.elasticsearch.hadoop.mr.EsInputFormat\",\r\n            keyClass=\"org.apache.hadoop.io.NullWritable\",\r\n            valueClass=\"org.elasticsearch.hadoop.mr.LinkedMapWritable\",\r\n            conf=es_read_conf)\r\n        print('--->',es_rdd.collect()[0][1])\r\n        return (12*estimatedValue)/es_rdd.collect()[0][1]['estimateValue']","dateFinished":"2020-08-17T13:39:39+0000","dateStarted":"2020-08-17T13:39:39+0000","results":{"code":"SUCCESS","msg":[]}},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1597669303891_-1687489997","id":"20200817-130143_91436486","dateCreated":"2020-08-17T13:01:43+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1701","text":"%spark.pyspark\n\nvalue=create_calculated_value(\"B25064\" , \"002\", \"12522\", 2014, 699)\nprint(value)","dateUpdated":"2020-08-17T13:40:39+0000","dateFinished":"2020-08-17T13:40:28+0000","dateStarted":"2020-08-17T13:40:27+0000","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"---> {'estimateValue': 67800.0, 'variableCodeType': '002', 'variableCode': 'B25119', 'vintage': 2014, 'geoId': '12522', 'id': '12522-2014-B25119_002', 'calculatedValue': 67800.0}\n0.12371681415929203\n"}]},"runtimeInfos":{"jobUrl":{"propertyName":"jobUrl","label":"SPARK JOB","tooltip":"View in Spark web UI","group":"spark","values":["http://ip-10-66-198-116.ec2.internal:4040/jobs/job?id=64","http://ip-10-66-198-116.ec2.internal:4040/jobs/job?id=65","http://ip-10-66-198-116.ec2.internal:4040/jobs/job?id=66","http://ip-10-66-198-116.ec2.internal:4040/jobs/job?id=67"],"interpreterSettingId":"spark"}}},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1597670425555_1997188430","id":"20200817-132025_2118040381","dateCreated":"2020-08-17T13:20:25+0000","status":"ERROR","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2040","text":"%spark.pyspark\r\nquery = `{\r\n            \"query\": {\r\n             \"bool\": {\r\n                 \"filter\": [\r\n                    {\r\n                        \"bool\": {\r\n                            \"must\": [\r\n                                {\r\n                                    \"match\": {\r\n                                        \"variableCode\": {}\r\n                                    }\r\n                                },\r\n                                {\r\n                                    \"match\": {\r\n                                        \"variableCodeType\": {}\r\n                                    }\r\n                                },\r\n                                {\r\n                                    \"match\": {\r\n                                         \"geoId\": {}\r\n                                    }\r\n                                },\r\n                                {\r\n                                    \"match\": {\r\n                                         \"vintage\": {}\r\n                                    }\r\n                                }\r\n                            ]\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        }\r\n        }`.format('B25119'\r\n        , '003', '123', '123')\r\n\r\n\r\nprint(query)","dateUpdated":"2020-08-17T13:29:26+0000","dateFinished":"2020-08-17T13:29:26+0000","dateStarted":"2020-08-17T13:29:26+0000","results":{"code":"ERROR","msg":[{"type":"TEXT","data":"Traceback (most recent call last):\n  File \"/tmp/zeppelin_pyspark-243343772968982747.py\", line 364, in <module>\n    code = compile('\\n'.join(stmts), '<stdin>', 'exec', ast.PyCF_ONLY_AST, 1)\n  File \"<stdin>\", line 1\n    query = `{\n            ^\nSyntaxError: invalid syntax\n"}]}},{"text":"%spark.pyspark\n","user":"anonymous","dateUpdated":"2020-08-17T13:21:58+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1597670518384_-1108535880","id":"20200817-132158_915036310","dateCreated":"2020-08-17T13:21:58+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2172"}],"name":"acs_pyxis","id":"2FHE3XPPD","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}